parameters:
- name: service_connection
  type: string
- name: tfstate_rg_name
  type: string
- name: tfstate_storage_account_name
  type: string
- name: tfstate_blob_name
  type: string
- name: tfstate_file_name
  type: string
- name: terraform_work_directory
  type: string
- name: spoke_vars_file_name
  type: string
- name: additional_command_options
  type: string

steps:
- checkout: self
  displayName: 'Checkout Repo'

- task: AzureCLI@2
  displayName: Azure Account
  inputs:
    azureSubscription: ${{parameters.service_connection}}
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      az --version
      az account show

- task: TerraformInstaller@1
  displayName: Install Terraform 1.8.2
  inputs:
    terraformVersion: 1.8.2

- task: TerraformTaskV4@4
  displayName: Terraform Init
  inputs:
    provider: 'azurerm'
    command: 'init'
    workingDirectory: '${{parameters.terraform_work_directory}}'
    backendServiceArm: '${{parameters.service_connection}}'
    backendAzureRmResourceGroupName: '${{parameters.tfstate_rg_name}}'
    backendAzureRmStorageAccountName: '${{parameters.tfstate_storage_account_name}}'
    backendAzureRmContainerName: '${{parameters.tfstate_blob_name}}'
    backendAzureRmKey: '${{parameters.tfstate_file_name}}.tfstate'

- task: TerraformTaskV4@4
  name: terraformPlan
  displayName: Terraform Plan
  inputs:
    provider: 'azurerm'
    command: 'plan'
    workingDirectory: '${{parameters.terraform_work_directory}}'
    commandOptions: '-var-file="${{parameters.terraform_work_directory}}/tfvars/${{parameters.spoke_vars_file_name}}.tfvars" ${{parameters.additional_command_options}} -lock=false -input=false -out main.tfplan'
    environmentServiceNameAzureRM: '${{parameters.service_connection}}'

# Only runs if the 'terraformPlan' task has detected changes the in state. 
- task: TerraformTaskV4@4
  displayName: Terraform Apply
  condition: eq(variables['terraformPlan.changesPresent'], 'true')
  inputs:
    provider: 'azurerm'
    command: 'apply'
    workingDirectory: '${{parameters.terraform_work_directory}}'
    commandOptions: 'main.tfplan'
    environmentServiceNameAzureRM: '${{parameters.service_connection}}'